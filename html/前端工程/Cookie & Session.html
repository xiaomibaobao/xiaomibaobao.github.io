<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>xiaomi-Blog</title>
    <link rel="stylesheet" type="text/css" href="../../static/css/main.css">
</head>
<body>
<div class="nav">
    <div class="logo">
        
            xiaomi-Blog
        
    </div>
<ul><li><a href="../../index.html">index</a></li><li><a href="#"><span></span>React</a><ul><li><a href="../../html/React/React一（初识React）.html">React一（初识React）</a></li><li><a href="../../html/React/React七（组件嵌套）.html">React七（组件嵌套）</a></li><li><a href="../../html/React/React三（数据流）.html">React三（数据流）</a></li><li><a href="../../html/React/React九（mixin）.html">React九（mixin）</a></li><li><a href="../../html/React/React二（JSX语法）.html">React二（JSX语法）</a></li><li><a href="../../html/React/React五（DOM操作）.html">React五（DOM操作）</a></li><li><a href="../../html/React/React八（表单操作）.html">React八（表单操作）</a></li><li><a href="../../html/React/React六（事件）.html">React六（事件）</a></li><li><a href="../../html/React/React十（编码规范）.html">React十（编码规范）</a></li><li><a href="../../html/React/React四（定义组件）.html">React四（定义组件）</a></li></ul></li><li><a href="#"><span></span>Node.js</a><ul><li><a href="../../html/Node.js/MongoDB.html">MongoDB</a></li><li><a href="../../html/Node.js/node 1.html">node 1</a></li><li><a href="../../html/Node.js/Node.js知识详解.html">Node.js知识详解</a></li><li><a href="../../html/Node.js/node入门(2).html">node入门(2)</a></li></ul></li><li><a href="#"><span></span>Angular</a><ul><li><a href="../../html/Angular/AngularJS 2.html">AngularJS 2</a></li><li><a href="../../html/Angular/AngularJS.html">AngularJS</a></li></ul></li><li><a href="#"><span></span>原生JavaScript</a><ul><li><a href="../../html/原生JavaScript/AJAX.html">AJAX</a></li><li><a href="../../html/原生JavaScript/DOM.html">DOM</a></li><li><a href="../../html/原生JavaScript/ES6.html">ES6</a></li><li><a href="../../html/原生JavaScript/HTTP.html">HTTP</a></li><li><a href="../../html/原生JavaScript/JS 基础知识拾遗.html">JS 基础知识拾遗</a></li><li><a href="../../html/原生JavaScript/Promise.html">Promise</a></li><li><a href="../../html/原生JavaScript/事件.html">事件</a></li><li><a href="../../html/原生JavaScript/函数.html">函数</a></li><li><a href="../../html/原生JavaScript/面向对象.html">面向对象</a></li><li><a href="../../html/原生JavaScript/CORS详解.html">CORS详解</a></li><li><a href="../../html/原生JavaScript/数组详谈.html">数组详谈</a></li><li><a href="../../html/原生JavaScript/正则表达式.html">正则表达式</a></li><li><a href="../../html/原生JavaScript/面向对象OOP.html">面向对象OOP</a></li></ul></li><li><a href="#"><span></span>设计、算法和思考</a><ul><li><a href="../../html/设计、算法和思考/学习Git.html">学习Git</a></li><li><a href="../../html/设计、算法和思考/性能优化待办事项.html">性能优化待办事项</a></li><li><a href="../../html/设计、算法和思考/性能优化点总结.html">性能优化点总结</a></li><li><a href="../../html/设计、算法和思考/订阅发布模式详解.html">订阅发布模式详解</a></li><li><a href="../../html/设计、算法和思考/BOM之 History对象.html">BOM之 History对象</a></li><li><a href="../../html/设计、算法和思考/BOM之window对象.html">BOM之window对象</a></li><li><a href="../../html/设计、算法和思考/Web离线存储的几种方式.html">Web离线存储的几种方式</a></li><li><a href="../../html/设计、算法和思考/缓存作用（304）.html">缓存作用（304）</a></li></ul></li><li><a href="#"><span></span>前端工程</a><ul><li><a href="../../html/前端工程/Git.html">Git</a></li><li><a href="../../html/前端工程/Gulp.html">Gulp</a></li><li><a href="../../html/前端工程/HTTP缓存.html">HTTP缓存</a></li><li><a href="../../html/前端工程/jade.html">jade</a></li><li><a href="../../html/前端工程/less.html">less</a></li><li><a href="../../html/前端工程/webpack入门及实践.html">webpack入门及实践</a></li><li class="active"><a href="../../html/前端工程/Cookie & Session.html">Cookie & Session</a></li><li><a href="../../html/前端工程/Express.html">Express</a></li><li><a href="../../html/前端工程/前端模块化之requireJS.html">前端模块化之requireJS</a></li></ul></li><li><a href="../../html/CONTACT.html">CONTACT</a></li></ul></div>


<div class="forkgithub"><a target="_blank" href="https://github.com/xiaomibaobao"></a></div>

<div class="warpper">

    <div class="page-toc">
        <ul><li><a href="#t0Cookie & Session">Cookie & Session</a><ul><li><a href="#t13. 获取cookie">3. 获取cookie</a><ul><li><a href="#t23.1 使用cookie-parser中间件来设置和获取cookie">3.1 使用cookie-parser中间件来设置和获取cookie</a></li><li><a href="#t33.2 cookieParser原理解析">3.2 cookieParser原理解析</a></li><li><a href="#t43.4记住密码页面的简单实现">3.4记住密码页面的简单实现</a></li></ul></li><li><a href="#t54 加密">4 加密</a><ul><li><a href="#t64.1常用的加密算法：">4.1常用的加密算法：</a></li><li><a href="#t74.2 MD5的原理：">4.2 MD5的原理：</a></li><li><a href="#t84.3 加密cookie">4.3 加密cookie</a></li></ul></li><li><a href="#t95 Session">5 Session</a></li></ul></li></ul>
    </div>
    
    <div class="content markdown-body">
        <h1 id="t0Cookie &amp; Session">Cookie &amp; Session <a href="#t0Cookie &amp; Session"> # </a></h1>
<blockquote>
<p>cookie&#x662F;&#x4E3A;&#x4E86;&#x8FA9;&#x522B;&#x7528;&#x6237;&#x8EAB;&#x4EFD;&#xFF0C;&#x8FDB;&#x884C;&#x4F1A;&#x8BDD;&#x8DDF;&#x8E2A;&#x800C;&#x5B58;&#x50A8;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x4E0A;&#x7684;&#x6570;&#x636E;
cookie&#x4F7F;&#x7528;&#x6CE8;&#x610F;&#x4E8B;&#x9879;</p>
<ul>
<li>&#x53EF;&#x80FD;&#x88AB;&#x5BA2;&#x6237;&#x7AEF;&#x7BE1;&#x6539;&#xFF0C;&#x4F7F;&#x7528;&#x524D;&#x9A8C;&#x8BC1;&#x5408;&#x6CD5;&#x6027;</li>
<li>&#x4E0D;&#x8981;&#x5B58;&#x50A8;&#x654F;&#x611F;&#x6570;&#x636E;&#xFF0C;&#x6BD4;&#x5982;&#x7528;&#x6237;&#x5BC6;&#x7801;&#xFF0C;&#x8D26;&#x6237;&#x4F59;&#x989D;</li>
<li>&#x4F7F;&#x7528;httpOnly&#x4FDD;&#x8BC1;&#x5B89;&#x5168;</li>
<li>&#x5C3D;&#x91CF;&#x51CF;&#x5C11;cookie&#x7684;&#x4F53;&#x79EF;</li>
<li>&#x8BBE;&#x7F6E;&#x6B63;&#x786E;&#x7684;domain&#x548C;path&#xFF0C;&#x51CF;&#x5C11;&#x6570;&#x636E;&#x4F20;&#x8F93;
###&#x3000;1.Cookie&#x7684;&#x5904;&#x7406;&#x6D41;&#x7A0B;
<img src="../..//img/cookie.jpg">
###&#x3000;2.&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;cookie</li>
<li>node&#x539F;&#x751F;&#xFF1A;<code>res.setHeader(&apos;Set-Cookie&apos;,[&apos;name=xiaomi&apos;,&apos;age=1&apos;]);</code></li>
<li>express&#xFF1A;<code>res.cookie(name,value,[,options]);</code>
options&#x8BE6;&#x7EC6;&#x8BF4;&#x660E;&#xFF1A;
|&#x53C2;&#x6570;|chrome&#x5BF9;&#x5E94;&#x5C5E;&#x6027;|&#x7C7B;&#x578B;|&#x8BF4;&#x660E;|&#x793A;&#x4F8B;|
|:-------|:-------|:-------|:-------|:-------|
|domain|Domain|String|&#x57DF;&#x540D;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;&#x5F53;&#x524D;&#x57DF;&#x540D;|{domain:&apos;a.zfpx.cn&apos;}|
|path|Path|String|&#x8DEF;&#x5F84;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;/|{path:&apos;/visit&apos;}|
|expires|Expires|Date|&#x8FC7;&#x671F;&#x65F6;&#x95F4;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x4EE5;&#x6709;&#x6307;&#x5B9A;&#x6216;&#x4E3A;0&#x8868;&#x793A;&#x5F53;&#x524D;&#x4F1A;&#x8BDD;&#x6709;&#x6548;|{expires:new Date(Date.now()+20<em>1000)}|
|maxAge|Max-Age|Number|&#x6709;&#x6548;&#x65F6;&#x95F4;(&#x5355;&#x4F4D;&#x662F;&#x6BEB;&#x79D2;)|{maxAge:20</em>1000}|
|httpOnly|HTTP|Boolean|&#x4E0D;&#x80FD;&#x901A;&#x8FC7;&#x6D4F;&#x89C8;&#x5668;javascript&#x8BBF;&#x95EE;|{httpOnly:true}|
|secure|Secure|String|&#x53EA;&#x901A;&#x8FC7;https&#x534F;&#x8BAE;&#x8BBF;&#x95EE;| |<h3 id="t13. &#x83B7;&#x53D6;cookie">3. &#x83B7;&#x53D6;cookie <a href="#t13. &#x83B7;&#x53D6;cookie"> # </a></h3>
<h5 id="t23.1 &#x4F7F;&#x7528;cookie-parser&#x4E2D;&#x95F4;&#x4EF6;&#x6765;&#x8BBE;&#x7F6E;&#x548C;&#x83B7;&#x53D6;cookie">3.1 &#x4F7F;&#x7528;cookie-parser&#x4E2D;&#x95F4;&#x4EF6;&#x6765;&#x8BBE;&#x7F6E;&#x548C;&#x83B7;&#x53D6;cookie <a href="#t23.1 &#x4F7F;&#x7528;cookie-parser&#x4E2D;&#x95F4;&#x4EF6;&#x6765;&#x8BBE;&#x7F6E;&#x548C;&#x83B7;&#x53D6;cookie"> # </a></h5>
<pre><code class="lang-javascript">$ npm install cookie-parser --save
</code></pre>
<pre><code class="lang-javascript">app.use(<span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;cookie-parser&apos;</span>)());    <span class="hljs-comment">//&#x4F7F;&#x7528;&#x4E2D;&#x95F4;&#x4EF6;</span>
response.cookie(key,value)              <span class="hljs-comment">//&#x5728;&#x54CD;&#x5E94;&#x4E2D;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x8BBE;&#x7F6E;cookie</span>
request.cookies                         <span class="hljs-comment">//&#x83B7;&#x53D6;&#x8BF7;&#x6C42;&#x4E2D;&#x7684;cookie&#x5BF9;&#x8C61;</span>
response.clearCookie(<span class="hljs-string">&apos;username&apos;</span>)        <span class="hljs-comment">//&#x6E05;&#x9664;cookie</span>
</code></pre>
<h5 id="t33.2 cookieParser&#x539F;&#x7406;&#x89E3;&#x6790;">3.2 cookieParser&#x539F;&#x7406;&#x89E3;&#x6790; <a href="#t33.2 cookieParser&#x539F;&#x7406;&#x89E3;&#x6790;"> # </a></h5>
```javascript
function cookieParser(req, res, next){
  if (!req.headers.cookie) {<pre><code>  return next();
</code></pre>  }
  req.cookies =  require(&apos;querystring&apos;).parse(req.headers.cookie,&apos;; &apos;,&apos;=&apos;);
  res.cookie = cookie;
  next();
}</li>
</ul>
</blockquote>
<p>function cookie(name, val, options) {
    var opt = options || {};
    var value = encodeURIComponent(val);
    var pairs = [name + &apos;=&apos; + value];
    if (null != opt.maxAge) {
        var maxAge = opt.maxAge - 0;
        if (isNaN(maxAge)) throw new Error(&apos;maxAge should be a Number&apos;);
        pairs.push(&apos;Max-Age=&apos; + Math.floor(maxAge));
    }</p>
<pre><code>if (opt.domain) {
    pairs.push(&apos;Domain=&apos; + opt.domain);
}

if (opt.path) {
    pairs.push(&apos;Path=&apos; + opt.path);
}

if (opt.expires) pairs.push(&apos;Expires=&apos; + opt.expires.toUTCString());
if (opt.httpOnly) pairs.push(&apos;HttpOnly&apos;);
if (opt.secure) pairs.push(&apos;Secure&apos;);

return pairs.join(&apos;; &apos;);
</code></pre><p>}</p>
<pre><code>
##### 3.3 &#x8BB0;&#x5F55;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8BBF;&#x95EE;&#x6B21;&#x6570;
```javascript
var express = require(&apos;express&apos;);
var cookieParser = require(&apos;cookie-parser&apos;);
var app = express();
/**
 * &#x5982;&#x679C;&#x8981;&#x52A0;&#x5BC6;&#x7684;&#x8BDD; cookieParser&#x91CC;&#x8981;&#x6307;&#x5B9A;&#x5BC6;&#x7801;&#xFF0C;&#x800C;&#x4E14;signed&#x8981;&#x7B49;&#x4E8E;true
 */
app.use(cookieParser(&apos;zfpx&apos;));
app.get(&apos;/write&apos;,function(req,res){
    res.cookie(&apos;age&apos;,&apos;123&apos;,{signed:true});//&#x9632;&#x6B62;&#x5BA2;&#x6237;&#x7AEF;&#x7BE1;&#x6539;cookie
    res.end(&apos;ok&apos;);
});

app.get(&apos;/read&apos;,function(req,res){
    console.log(req.signedCookies);//&#x8BFB;&#x53D6;&#x6B63;&#x786E;&#x7684;&#x7684;cookies
    res.send(req.cookies);
});

//&#x8BB0;&#x5F55;&#x8FD9;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x7B2C;&#x51E0;&#x6B21;&#x8BBF;&#x95EE;
app.get(&apos;/visit&apos;,function(req,res){
    res.cookie(&apos;count&apos;,isNaN(req.cookies.count)?0:parseInt(req.cookies.count)+1);
    res.send(req.cookies);
});
app.listen(9090);
</code></pre><h5 id="t43.4&#x8BB0;&#x4F4F;&#x5BC6;&#x7801;&#x9875;&#x9762;&#x7684;&#x7B80;&#x5355;&#x5B9E;&#x73B0;">3.4&#x8BB0;&#x4F4F;&#x5BC6;&#x7801;&#x9875;&#x9762;&#x7684;&#x7B80;&#x5355;&#x5B9E;&#x73B0; <a href="#t43.4&#x8BB0;&#x4F4F;&#x5BC6;&#x7801;&#x9875;&#x9762;&#x7684;&#x7B80;&#x5355;&#x5B9E;&#x73B0;"> # </a></h5>
<pre><code class="lang-javascript">&lt;!DOCTYPE html&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">html</span> <span class="hljs-attribute">lang</span>=<span class="hljs-value">&quot;en&quot;</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">charset</span>=<span class="hljs-value">&quot;UTF-8&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="javascript">
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setCookie</span>(<span class="hljs-params">key,value</span>)</span>{
            <span class="hljs-built_in">document</span>.cookie = key+<span class="hljs-string">&quot;=&quot;</span>+value;
        }
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCookie</span>(<span class="hljs-params">key</span>)</span>{
            <span class="hljs-keyword">if</span>(<span class="hljs-built_in">document</span>.cookie){
                <span class="hljs-keyword">var</span> parts = <span class="hljs-built_in">document</span>.cookie.split(<span class="hljs-string">&apos;; &apos;</span>);
                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;parts.length;i++){
                    <span class="hljs-keyword">var</span> vals = parts[i].split(<span class="hljs-string">&apos;=&apos;</span>);
                    <span class="hljs-keyword">if</span>(vals[<span class="hljs-number">0</span>]==key){
                        <span class="hljs-keyword">return</span> vals[<span class="hljs-number">1</span>];
                    }
                }
                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
            }<span class="hljs-keyword">else</span>{
                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
            }
        }
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkCookie</span>(<span class="hljs-params"></span>)</span>{
            <span class="hljs-keyword">var</span> username = getCookie(<span class="hljs-string">&apos;username&apos;</span>);
            <span class="hljs-keyword">if</span>(username){
                alert(<span class="hljs-string">&apos;&#x6B22;&#x8FCE;&apos;</span>+username+<span class="hljs-string">&apos;&#x518D;&#x6B21;&#x8BBF;&#x95EE;&apos;</span>);
                <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">&apos;#username&apos;</span>).value = username;
            }<span class="hljs-keyword">else</span>{
                username = prompt(<span class="hljs-string">&apos;&#x8BF7;&#x8F93;&#x5165;&#x7528;&#x6237;&#x540D;:&apos;</span>);
                <span class="hljs-keyword">if</span>(username){
                    setCookie(<span class="hljs-string">&apos;username&apos;</span>,username);
                }
            }
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">body</span> <span class="hljs-attribute">onLoad</span>=<span class="hljs-value">&quot;checkCookie()&quot;</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">&quot;text&quot;</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">&quot;username&quot;</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span>
</span></code></pre>
<h3 id="t54 &#x52A0;&#x5BC6;">4 &#x52A0;&#x5BC6; <a href="#t54 &#x52A0;&#x5BC6;"> # </a></h3>
<p><code>var crypto=require(&apos;crypto&apos;);</code></p>
<h5 id="t64.1&#x5E38;&#x7528;&#x7684;&#x52A0;&#x5BC6;&#x7B97;&#x6CD5;&#xFF1A;">4.1&#x5E38;&#x7528;&#x7684;&#x52A0;&#x5BC6;&#x7B97;&#x6CD5;&#xFF1A; <a href="#t64.1&#x5E38;&#x7528;&#x7684;&#x52A0;&#x5BC6;&#x7B97;&#x6CD5;&#xFF1A;"> # </a></h5>
<p>crypto.createHash(&apos;sha1&apos;).update(&apos;1&apos;).digest(&apos;hex&apos;);
crypto.createHash(&apos;sha256&apos;).update(&apos;1&apos;).digest(&apos;hex&apos;);
crypto.createHash(&apos;md5&apos;).update(&apos;1&apos;).digest(&apos;hex&apos;);
crypto.getHashes(&apos;sha1&apos;).update(&apos;1&apos;).digest(&apos;hex&apos;);</p>
<blockquote>
<p><strong>HMAC&#x7B97;&#x6CD5;</strong>HMAC&#x7B97;&#x6CD5;&#x5C06;&#x6563;&#x5217;&#x7B97;&#x6CD5;&#x4E0E;&#x4E00;&#x4E2A;&#x5BC6;&#x94A5;&#x7ED3;&#x5408;&#x5728;&#x4E00;&#x8D77;&#xFF0C;&#x4EE5;&#x963B;&#x6B62;&#x5BF9;&#x7B7E;&#x540D;&#x5B8C;&#x6574;&#x6027;&#x7684;&#x7834;&#x574F; &#x751F;&#x6210;&#x79C1;&#x94A5;.</p>
<pre><code>$ openssl genrsa -out key.pem 1024
var crypto = require(&apos;crypto&apos;);
var shasum = crypto.createHmac(&apos;sha1&apos;, &apos;xiaomi&apos;);//&#x6839;&#x636E;&#x81EA;&#x5DF1;&#x8BBE;&#x5B9A;&#x7684;&#x5BC6;&#x94A5;&#x8BBE;&#x7F6E;&#xFF0C;&#x53EF;&#x4EE5;&#x9632;&#x6B62;&#x53CD;&#x63A8;&#x3002;
var result = shasum.update(&apos;hello&apos;).digest(&apos;hex&apos;);//digest&#x6307;&#x5B9A;&#x7F16;&#x7801;&#xFF0C;&#x6BD4;&#x5982;hex&#xFF0C;base64
console.log(result);
</code></pre></blockquote>
<h5 id="t74.2 MD5&#x7684;&#x539F;&#x7406;&#xFF1A;">4.2 MD5&#x7684;&#x539F;&#x7406;&#xFF1A; <a href="#t74.2 MD5&#x7684;&#x539F;&#x7406;&#xFF1A;"> # </a></h5>
<blockquote>
<ul>
<li>md5 &#x628A;&#x4EFB;&#x610F;&#x957F;&#x5EA6;&#x7684;&#x8F93;&#x5165;&#xFF0C;&#x53D8;&#x6210;&#x56FA;&#x5B9A;&#x957F;&#x5EA6;&#x7684;&#x8F93;&#x51FA;&#x3002;&#x7528;&#x6765;&#x5B8C;&#x6574;&#x6027;&#x6821;&#x9A8C;,&#x52A0;&#x5BC6;&#x5BC6;&#x7801;&#x7B49;&#x3002;</li>
<li>&#x4E0D;&#x540C;&#x7684;&#x8F93;&#x5165;&#x6C38;&#x8FDC;&#x4EA7;&#x751F;&#x4E0D;&#x540C;&#x7684;&#x8F93;&#x51FA;&#xFF0C;&#x76F8;&#x540C;&#x8F93;&#x5165;&#x4F1A;&#x6C38;&#x8FDC;&#x76F8;&#x540C;&#x8F93;&#x51FA;&#x3002;</li>
<li>&#x4E0D;&#x80FD;&#x4ECE;&#x8F93;&#x51FA;&#x53CD;&#x63A8;&#x8F93;&#x5165;&#xFF0C;&#x8BA1;&#x7B97;&#x4E0D;&#x53EF;&#x9006;&#x3002;</li>
</ul>
</blockquote>
<h5 id="t84.3 &#x52A0;&#x5BC6;cookie">4.3 &#x52A0;&#x5BC6;cookie <a href="#t84.3 &#x52A0;&#x5BC6;cookie"> # </a></h5>
<pre><code>var crypto = require(&apos;crypto&apos;);
var sign = function(val, secret){
    return val + &apos;.&apos; + crypto
            .createHmac(&apos;sha256&apos;, secret)
            .update(val)
            .digest(&apos;base64&apos;)
            .replace(/\=+$/, &apos;&apos;);
};
console.log(sign(&apos;123&apos;,&apos;xiaomi&apos;));
</code></pre><h3 id="t95 Session">5 Session <a href="#t95 Session"> # </a></h3>
<p>#####5.1 &#x4EC0;&#x4E48;&#x662F;session
session&#x662F;&#x53E6;&#x4E00;&#x79CD;&#x8BB0;&#x5F55;&#x5BA2;&#x6237;&#x72B6;&#x6001;&#x7684;&#x673A;&#x5236;&#xFF0C;&#x4E0D;&#x540C;&#x7684;&#x662F;Cookie&#x4FDD;&#x5B58;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x6D4F;&#x89C8;&#x5668;&#x4E2D;&#xFF0C;&#x800C;session&#x4FDD;&#x5B58;&#x5728;&#x670D;&#x52A1;&#x5668;&#x4E0A;</p>
<p>&#x5BA2;&#x6237;&#x7AEF;&#x6D4F;&#x89C8;&#x5668;&#x8BBF;&#x95EE;&#x670D;&#x52A1;&#x5668;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x628A;&#x5BA2;&#x6237;&#x7AEF;&#x4FE1;&#x606F;&#x4EE5;&#x67D0;&#x79CD;&#x5F62;&#x5F0F;&#x8BB0;&#x5F55;&#x5728;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;session&#x3002;&#x5BA2;&#x6237;&#x7AEF;&#x6D4F;&#x89C8;&#x5668;&#x518D;&#x6B21;&#x8BBF;&#x95EE;&#x65F6;&#x53EA;&#x9700;&#x8981;&#x4ECE;&#x8BE5;Session&#x4E2D;&#x67E5;&#x627E;&#x8BE5;&#x5BA2;&#x6237;&#x7684;&#x72B6;&#x6001;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;</p>
<p>#####5.2 cookie&#x4E0E;session&#x533A;&#x522B;</p>
<ol>
<li>cookie&#x6570;&#x636E;&#x5B58;&#x653E;&#x5728;&#x5BA2;&#x6237;&#x7684;&#x6D4F;&#x89C8;&#x5668;&#x4E0A;&#xFF0C;session&#x6570;&#x636E;&#x653E;&#x5728;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x3002;</li>
<li>cookie&#x4E0D;&#x662F;&#x5F88;&#x5B89;&#x5168;&#xFF0C;&#x522B;&#x4EBA;&#x53EF;&#x4EE5;&#x5206;&#x6790;&#x5B58;&#x653E;&#x5728;&#x672C;&#x5730;&#x7684;COOKIE&#x5E76;&#x8FDB;&#x884C;COOKIE&#x6B3A;&#x9A97; &#x8003;&#x8651;&#x5230;&#x5B89;&#x5168;&#x5E94;&#x5F53;&#x4F7F;&#x7528;session</li>
<li>session&#x4F1A;&#x5728;&#x4E00;&#x5B9A;&#x65F6;&#x95F4;&#x5185;&#x4FDD;&#x5B58;&#x5728;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x3002;&#x5F53;&#x8BBF;&#x95EE;&#x589E;&#x591A;&#xFF0C;&#x4F1A;&#x6BD4;&#x8F83;&#x5360;&#x7528;&#x4F60;&#x670D;&#x52A1;&#x5668;&#x7684;&#x6027;&#x80FD; &#x8003;&#x8651;&#x5230;&#x51CF;&#x8F7B;&#x670D;&#x52A1;&#x5668;&#x6027;&#x80FD;&#x65B9;&#x9762;,&#x5E94;&#x5F53;&#x4F7F;&#x7528;COOKIE</li>
<li>&#x5355;&#x4E2A;cookie&#x4FDD;&#x5B58;&#x7684;&#x6570;&#x636E;&#x4E0D;&#x80FD;&#x8D85;&#x8FC7;4K&#xFF0C;&#x5F88;&#x591A;&#x6D4F;&#x89C8;&#x5668;&#x90FD;&#x9650;&#x5236;&#x4E00;&#x4E2A;&#x7AD9;&#x70B9;&#x6700;&#x591A;&#x4FDD;&#x5B58;20&#x4E2A;cookie<blockquote>
<p>&#x5C06;&#x767B;&#x9646;&#x4FE1;&#x606F;&#x7B49;&#x91CD;&#x8981;&#x4FE1;&#x606F;&#x5B58;&#x653E;&#x4E3A;session&#x3001;&#x5176;&#x4ED6;&#x4FE1;&#x606F;&#x5982;&#x679C;&#x9700;&#x8981;&#x4FDD;&#x7559;&#xFF0C;&#x53EF;&#x4EE5;&#x653E;&#x5728;cookie&#x4E2D;</p>
</blockquote>
</li>
</ol>
<p>#####5.3 session&#x5B9E;&#x73B0;</p>
<ol>
<li>&#x5728;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x751F;&#x6210;&#x5168;&#x5C40;&#x552F;&#x4E00;&#x6807;&#x8BC6;&#x7B26;<code>session_id</code></li>
<li>&#x5728;&#x670D;&#x52A1;&#x5668;&#x5185;&#x5B58;&#x91CC;&#x5F00;&#x8F9F;&#x6B64;<code>session_id</code>&#x5BF9;&#x5E94;&#x7684;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;</li>
<li>&#x5C06;<code>session_id</code>&#x4F5C;&#x4E3A;&#x5168;&#x5C40;&#x552F;&#x4E00;&#x6807;&#x793A;&#x7B26;&#x901A;&#x8FC7;<code>cookie</code>&#x53D1;&#x9001;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;</li>
<li>&#x4EE5;&#x540E;&#x5BA2;&#x6237;&#x7AEF;&#x518D;&#x6B21;&#x8BBF;&#x95EE;&#x670D;&#x52A1;&#x5668;&#x65F6;&#x4F1A;&#x628A;<code>session_id</code>&#x901A;&#x8FC7;&#x8BF7;&#x6C42;&#x5934;&#x4E2D;&#x7684;<code>cookie</code>&#x53D1;&#x9001;&#x7ED9;&#x670D;&#x52A1;&#x5668;</li>
<li>&#x670D;&#x52A1;&#x5668;&#x518D;&#x901A;&#x8FC7;<code>session_id</code>&#x628A;&#x6B64;&#x6807;&#x8BC6;&#x7B26;&#x5728;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x7684;&#x6570;&#x636E;&#x53D6;&#x51FA;</li>
</ol>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;express&apos;</span>);
<span class="hljs-keyword">var</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;cookie-parser&apos;</span>);
<span class="hljs-keyword">var</span> app = express();
app.use(cookieParser());
<span class="hljs-comment">//&#x5B58;&#x653E;&#x4F1A;&#x8BDD;&#x6570;&#x636E; key&#x5361;&#x53F7; value&#x5C31;&#x662F;&#x5361;&#x53F7;&#x5BF9;&#x5E94;&#x7684;&#x6570;&#x636E;&#x5BF9;&#x8C61;</span>
<span class="hljs-keyword">var</span> sessions = {};
<span class="hljs-comment">//&#x4E0E;&#x5BA2;&#x6237;&#x7AEF;&#x7EA6;&#x5B9A;&#x7684;&#x4F1A;&#x8BDD;ID</span>
<span class="hljs-keyword">var</span> SESSION_KEY = <span class="hljs-string">&apos;session.id&apos;</span>
<span class="hljs-comment">//&#x5F53;&#x7528;&#x6237;&#x8BBF;&#x95EE;&#x6839;&#x76EE;&#x5F55;&#x7684;&#x65F6;&#x5019; &#x6267;&#x884C;&#x5BF9;&#x5E94;&#x7684;&#x56DE;&#x8C03;&#x51FD;&#x6570;</span>
app.get(<span class="hljs-string">&apos;/&apos;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res</span>)</span>{
    res.setHeader(<span class="hljs-string">&apos;Content-Type&apos;</span>,<span class="hljs-string">&apos;text/html;charset=utf-8&apos;</span>);
   <span class="hljs-comment">// 1. &#x5148;&#x53D6;&#x51FA;cookie&#x4E2D;&#x7684;sessionId &#x5361;&#x53F7;</span>
    <span class="hljs-keyword">var</span> sessionId = req.cookies[SESSION_KEY];
    <span class="hljs-comment">// &#x5982;&#x679C;&#x6709;&#x5361;&#x53F7;&#x7684;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6709;ID&#x7684;&#x8BDD; &#x8001;&#x987E;&#x5BA2;</span>
    <span class="hljs-keyword">if</span>(sessionId){
        <span class="hljs-comment">//&#x53D6;&#x51FA;&#x6B64;&#x5361;&#x53F7;&#x5BF9;&#x5E94;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x4F59;&#x989D;</span>
        <span class="hljs-keyword">var</span> sessionObj = sessions[sessionId];
        <span class="hljs-keyword">if</span>(sessionObj){
            <span class="hljs-comment">//&#x6263;&#x6389;10&#x5757;&#x94B1;</span>
            sessionObj.balance = sessionObj.balance -<span class="hljs-number">10</span>;
            res.send(<span class="hljs-string">&apos;&#x6B22;&#x8FCE;&#x4F60;&#x8001;&#x987E;&#x5BA2;&#xFF0C;&#x4F60;&#x5361;&#x4E0A;&#x8FD8;&#x5269;&apos;</span>+sessionObj.balance);
        }<span class="hljs-keyword">else</span>{
            genId(res);
        }
    <span class="hljs-comment">//&#x5982;&#x679C;&#x6CA1;&#x6709;&#x7684;&#x8BDD;&#x5C31;&#x662F;&#x65B0;&#x987E;&#x5BA2;</span>
    }<span class="hljs-keyword">else</span>{
        genId(res);
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">genId</span>(<span class="hljs-params">res</span>)</span>{
        <span class="hljs-comment">//&#x7531;&#x5E97;&#x5BB6;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x552F;&#x4E00;&#x7684;&#x5361;&#x53F7;</span>
        <span class="hljs-keyword">var</span> id = <span class="hljs-built_in">Date</span>.now()+<span class="hljs-string">&apos;&apos;</span>+<span class="hljs-built_in">Math</span>.random();
        <span class="hljs-comment">//&#x8981;&#x5728;&#x5E97;&#x5BB6;&#x7684;&#x5C0F;&#x672C;&#x4E0A;&#x8BB0;&#x5F55;&#x4E00;&#x4E0B;&#x6B64;&#x5361;&#x53F7;&#x5BF9;&#x5E94;&#x7684;&#x4F59;&#x989D;</span>
        sessions[id] = {balance:<span class="hljs-number">100</span>};
        <span class="hljs-comment">//&#x628A;&#x8FD9;&#x4E2A;&#x5361;&#x53D1;&#x7ED9;&#x987E;&#x5BA2;&#x5E26;&#x56DE;&#x5BB6;</span>
        res.cookie(SESSION_KEY,id);
        <span class="hljs-comment">//&#x544A;&#x8BC9; &#x7528;&#x6237;&#x9001;&#x4ED6;&#x4E00;&#x5F20;&#x5361;</span>
        res.send(<span class="hljs-string">&apos;&#x6B22;&#x8FCE;&#x4F60;&#x65B0;&#x987E;&#x5BA2;&#xFF0C;&#x9001;&#x4F60;&#x4E00;&#x5F20;&#x4EF7;&#x503C;100&#x5143;&#x7684;&#x526A;&#x53D1;&#x5361;&apos;</span>);
    }
});

app.listen(<span class="hljs-number">9090</span>);
</code></pre>
<p>#####5.4 session&#x4E2D;&#x95F4;&#x4EF6;</p>
<pre><code class="lang-javascript">$ npm install express-session
</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left">&#x53C2;&#x6570;</th>
<th style="text-align:left">&#x63CF;&#x8FF0;</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">name</td>
<td style="text-align:left">&#x8BBE;&#x7F6E; cookie &#x4E2D;&#xFF0C;&#x4FDD;&#x5B58; session &#x7684;&#x5B57;&#x6BB5;&#x540D;&#x79F0;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; connect.sid</td>
</tr>
<tr>
<td style="text-align:left">store</td>
<td style="text-align:left">session &#x7684;&#x5B58;&#x50A8;&#x65B9;&#x5F0F;&#xFF0C;&#x9ED8;&#x8BA4;&#x5B58;&#x653E;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; redis&#xFF0C;mongodb &#x7B49;</td>
</tr>
<tr>
<td style="text-align:left">secret</td>
<td style="text-align:left">&#x901A;&#x8FC7;&#x8BBE;&#x7F6E;&#x7684; secret &#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x6765;&#x8BA1;&#x7B97; hash &#x503C;&#x5E76;&#x653E;&#x5728; cookie &#x4E2D;&#xFF0C;&#x4F7F;&#x4EA7;&#x751F;&#x7684; signedCookie &#x9632;&#x7BE1;&#x6539;</td>
</tr>
<tr>
<td style="text-align:left">cookie</td>
<td style="text-align:left">&#x8BBE;&#x7F6E;&#x5B58;&#x653E; session id &#x7684; cookie &#x7684;&#x76F8;&#x5173;&#x9009;&#x9879;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; (default: { path: &apos;/&apos;, httpOnly: true, secure: false, maxAge: null })</td>
</tr>
<tr>
<td style="text-align:left">genid</td>
<td style="text-align:left">&#x4EA7;&#x751F;&#x4E00;&#x4E2A;&#x65B0;&#x7684; session_id &#x65F6;&#xFF0C;&#x6240;&#x4F7F;&#x7528;&#x7684;&#x51FD;&#x6570;&#xFF0C; &#x9ED8;&#x8BA4;&#x4F7F;&#x7528; uid2 &#x8FD9;&#x4E2A; npm &#x5305;</td>
</tr>
<tr>
<td style="text-align:left">rolling</td>
<td style="text-align:left">&#x6BCF;&#x4E2A;&#x8BF7;&#x6C42;&#x90FD;&#x91CD;&#x65B0;&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A; cookie&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; false</td>
</tr>
<tr>
<td style="text-align:left">resave</td>
<td style="text-align:left">&#x5373;&#x4F7F; session &#x6CA1;&#x6709;&#x88AB;&#x4FEE;&#x6539;&#xFF0C;&#x4E5F;&#x4FDD;&#x5B58; session &#x503C;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A; true</td>
</tr>
</tbody>
</table>
<p>#####5.5 &#x5C0F;&#x6848;&#x4F8B;&#xFF1A; session&#x5B9E;&#x73B0;&#x6743;&#x9650;</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;express&apos;</span>);
<span class="hljs-keyword">var</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;cookie-parser&apos;</span>);
<span class="hljs-keyword">var</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;express-session&apos;</span>);
<span class="hljs-keyword">var</span> uuid = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;uuid&apos;</span>);
<span class="hljs-keyword">var</span> app = express();
app.set(<span class="hljs-string">&apos;view engine&apos;</span>, <span class="hljs-string">&apos;html&apos;</span>);
app.engine(<span class="hljs-string">&apos;html&apos;</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;ejs&apos;</span>).__express);
app.set(<span class="hljs-string">&apos;views&apos;</span>, __dirname);
app.use(<span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;cookie-parser&apos;</span>)());

app.use(session({secret: <span class="hljs-string">&apos;zfpx&apos;</span>,
    resave: <span class="hljs-literal">true</span>,
    saveUninitialized: <span class="hljs-literal">true</span>}));

<span class="hljs-comment">/**
 * curl -v -H &quot;cookie: username=customer&quot; http://localhost:8080/user
 */</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkUser</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">if</span> (req.session &amp;&amp; req.session.username)
        next();
    <span class="hljs-keyword">else</span>
        res.redirect(<span class="hljs-string">&apos;/&apos;</span>);
}

<span class="hljs-comment">//&#x8FDB;&#x5165;&#x767B;&#x5F55;&#x9875;</span>
app.get(<span class="hljs-string">&apos;/&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
    res.render(<span class="hljs-string">&apos;index&apos;</span>);
});

<span class="hljs-comment">//&#x767B;&#x5F55;</span>
app.get(<span class="hljs-string">&apos;/login&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
    req.session.username = req.query.username;
    res.redirect(<span class="hljs-string">&apos;/user&apos;</span>);
});

<span class="hljs-comment">//&#x7528;&#x6237;&#x9875;&#x9762;</span>
app.get(<span class="hljs-string">&apos;/user&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
    <span class="hljs-built_in">console</span>.log(req.session);
    res.render(<span class="hljs-string">&apos;user&apos;</span>, {username: req.session.username});
});

<span class="hljs-comment">//&#x7528;&#x6237;&#x9000;&#x51FA;</span>
app.get(<span class="hljs-string">&apos;/logout&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
    req.session.usrename = <span class="hljs-literal">null</span>;
    res.redirect(<span class="hljs-string">&apos;/&apos;</span>);
});


app.listen(<span class="hljs-number">8080</span>);
</code></pre>
<p>#####5.6 &#x5B58;&#x50A8;&#x5230;mongodb&#x6570;&#x636E;&#x5E93;
session&#x6570;&#x636E;&#x90FD;&#x662F;&#x5B58;&#x50A8;&#x5728;&#x5185;&#x5B58;&#x5F53;&#x4E2D;&#x7684;&#xFF0C;&#x5F53;&#x8FDB;&#x7A0B;&#x9000;&#x51FA;&#x540E;&#xFF0C;session&#x6570;&#x636E;&#x5C31;&#x4F1A;&#x4E22;&#x5931;
&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x628A;session&#x5B58;&#x50A8;&#x5230;mongodb&#x6570;&#x636E;&#x5E93;&#x5F53;&#x4E2D;</p>
<pre><code>$ npm install connect-mongo
</code></pre><pre><code class="lang-javascript"><span class="hljs-keyword">var</span> MongoStore = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;connect-mongo&apos;</span>)(session);
<span class="hljs-comment">//&#x89E3;&#x6790; cookie &#x8BF7;&#x6C42;&#x5934;&#x4E2D;&#x7684;cookie&#x8F6C;&#x6210;&#x5BF9;&#x8C61; req.cookies</span>
app.use(cookieParser());
<span class="hljs-comment">// req.session</span>
app.use(session({
  secret:<span class="hljs-string">&apos;zfpx&apos;</span>,<span class="hljs-comment">//&#x52A0;&#x5BC6;cookie&#x7684;&#x5BC6;&#x94A5;</span>
  resave:<span class="hljs-literal">true</span>,<span class="hljs-comment">//&#x91CD;&#x65B0;&#x4FDD;&#x5B58;</span>
  saveUninitialized:<span class="hljs-literal">true</span>,<span class="hljs-comment">//&#x4FDD;&#x5B58;&#x672A;&#x521D;&#x59CB;&#x5316;&#x7684;session</span>
  store:<span class="hljs-keyword">new</span> MongoStore({<span class="hljs-comment">// &#x6307;&#x5B9A;&#x4F1A;&#x8BDD;&#x7684;&#x6570;&#x636E;&#x5E93;&#x5B58;&#x50A8;&#x4F4D;&#x7F6E;</span>
    url:<span class="hljs-string">&apos;mongodb://123.57.143.189:27017/zhufengnodejs&apos;</span>
  })
}));
</code></pre>

        <div class="copyright">Powered by <a href="https://github.com/jaywcjlove/idoc" target="_blank">idoc</a>. Dependence <a href="https://nodejs.org">Node.js</a> run.</div>
    </div>
    
</div>


</body>
</html>
